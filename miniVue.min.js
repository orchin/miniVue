/* 
* miniVue.js - v1.1.0
* Developed by Orchin<793970086@qq.com>
* start from 2018.10
* 模仿Vuejs的原理开发的简单数据驱动框架； 
*/
var miniVue=function(a){var b=a.el,c=a.methods;this.$data=a.data;this.$el=document.querySelector(b);this.$methods=c;this.$mv={};this.$textNodes=[];this.$loopNodes=[];this.$hasNewNodes=!0;this.initListener();this.initUpdater();this.initObserver()};miniVue.prototype.isObject=function(a){return null!=a&&"object"==typeof a};miniVue.prototype.getDataByKey=function(a){if(a){a=a.replace(/\s+/g,"");a=a.split(".");var b=this.$data,c;for(c in a)if(b=b[a[c]],void 0==b||null==b)break;return b}};miniVue.prototype.setDataByKey=function(a,b){if(!a)return!1;a=a.replace(/\s+/g,"");for(var c=a.split("."),d=this.$data,e=0,f=0;f<c.length-1&&(d=d[c[f]],e++,void 0!=d&&null!=d);f++);if(!d)return!1;d[c[e]]=b;return!0};miniVue.prototype.getAttrDoms=function(a,b,c){this.$el.querySelectorAll(a).forEach(function(a,e){if(1==a.nodeType&&a.hasAttribute(b)){var d=a.getAttribute(b);d&&c(a,d)}})};miniVue.prototype.nextElementSiblings=function(a){return a.nextSibling?1==a.nextSibling.nodeType?a.nextSibling:this.nextElementSiblings(a.nextSibling):null};miniVue.prototype.initObserver=function(){this.observer(this.$data)};miniVue.prototype.observer=function(a,b){b=void 0===b?"":b;if(this.isObject(a))for(var c in a)this.defineReactive(c,a[c],a,b)};miniVue.prototype.defineReactive=function(a,b,c,d){var e=this,f=d?d+"."+a:a;Object.defineProperty(c,a,{enumerable:!0,configurable:!0,get:function(){return b},set:function(a){b!==a&&(b=a,e.updater(f),e.isObject(a)&&e.observer(a,f))}});e.observer(b,f)};miniVue.prototype.initUpdater=function(){this.updater()};miniVue.prototype.updater=function(a){console.log("set:",a,"   data:",this.$data);this.update_loop(a);this.update_text(a);this.update_bind(a);this.update_model(a);this.update_select(a);this.update_condition(a);this.$hasNewNodes=!1};miniVue.prototype.update_bind=function(a){var b=this,c=["value","src","href","class"],d=[];c.forEach(function(c,f){d[f]=a&&!b.$hasNewNodes?"*[\\:"+c+"\x3d'"+a+"']":"*[\\:"+c+"]"});d.forEach(function(a,d){b.getAttrDoms(a,":"+c[d],function(a,e){"class"==c[d]?(a.temp_class&&a.classList.remove(a.temp_class),a.temp_class=b.getDataByKey(e),a.classList.add(a.temp_class)):a[c[d]]=b.getDataByKey(e)})})};miniVue.prototype.update_model=function(a){var b=this;this.getAttrDoms(a&&!this.$hasNewNodes?"input[v-model\x3d'"+a+"'],textarea[v-model\x3d'"+a+"']":"input[v-model],textarea[v-model]","v-model",function(a,d){a.value=b.getDataByKey(d)})};miniVue.prototype.update_select=function(a){var b=this;a=a&&!this.$hasNewNodes?"select[v-model\x3d'"+a+"'],select[\\:value\x3d'"+a+"']":"select[v-model],select[\\:value]";var c=function(a,c){var d=b.getDataByKey(c);a.querySelectorAll("option").forEach(function(a){a.value==d?a.setAttribute("selected",!0):a.removeAttribute("selected")})};this.getAttrDoms(a,"v-model",c);this.getAttrDoms(a,":value",c)};miniVue.prototype.matchTextNodes=function(a){var b=this,c=/{{ *([\w_\-\.\[\]]+) *}}/g,d=[];a.forEach(function(a){3==a.nodeType&&a.nodeValue.match(c)?d.push({node:a,value:a.nodeValue}):a.nodeType&&0<a.childNodes.length&&(d=d.concat(b.matchTextNodes(a.childNodes)))});return d};miniVue.prototype.update_text=function(a){if(a){var b=this.matchTextNodes(this.$el.childNodes);this.$textNodes=this.$textNodes.concat(b)}else this.$textNodes=this.matchTextNodes(this.$el.childNodes);var b=/{{ *([\w_\-\.\[\]]+) *}}/g,c;for(c in this.$textNodes){var d=this.$textNodes[c],e=d.value;if(!a||this.$hasNewNodes||e.match(new RegExp("{{ *(["+a+"]+) *}}","g"))){var f=e.match(b),h;for(h in f)var g=f[h].slice(2,-2),e=e.replace(f[h],this.getDataByKey(g));d.node.nodeValue=e}}};miniVue.prototype.analysisExpression=function(a){a=a.replace(/\b(?<![\"\'])([a-zA-Z][a-zA-Z0-9\.\_]+)/g,"this.$data.$1");a=a.replace(/\.(\d)\./g,"[$1].");return eval(a)};miniVue.prototype.showHideElement=function(a,b){b?"none"==a.style.display&&(a.style.display=a.temp_display||""):("none"!=a.style.display&&(a.temp_display=a.style.display),a.style.display="none")};miniVue.prototype.update_condition=function(){var a=this;this.getAttrDoms("*","v-show",function(b,c){a.analysisExpression(c)?a.showHideElement(b,!0):a.showHideElement(b,!1)});this.getAttrDoms("*","v-if",function(b,c){var d=a.nextElementSiblings(b);a.analysisExpression(c)?(a.showHideElement(b,!0),d&&d.hasAttribute("v-else")&&a.showHideElement(d,!1)):(a.showHideElement(b,!1),d&&d.hasAttribute("v-else")&&a.showHideElement(d,!0))})};miniVue.prototype.analysisLoopItem=function(a){a=a.split("in");return{item:a[0].replace(/\s+/g,""),key:a[1].replace(/\s+/g,"")}};miniVue.prototype.update_loop=function(a){var b=this;a||this.getAttrDoms("*","v-for",function(a,d){var c=a.parentNode,f=document.createComment(Math.floor(1E5*Math.random()));c.replaceChild(f,a);c=b.analysisLoopItem(d);b.$loopNodes.push({node:a,exp:d,point:f,itemKey:c.item,dataKey:c.key,data:b.getDataByKey(c.key),children:[]})});this.$loopNodes.forEach(function(c,d){if(!a||c.dataKey==a){c.data=b.getDataByKey(c.dataKey);b.$hasNewNodes=!0;var e=0,f=new RegExp("\\b"+c.itemKey+"\\b","g"),h=c.node.cloneNode(!0);h.removeAttribute("v-for");for(d in c.children){var g=c.children[d];g.parentNode.removeChild(g)}c.children.length=0;for(d in c.data)g=document.createElement("div"),g.innerHTML=h.outerHTML.replace(f,c.dataKey+"."+e+""),g.firstChild.temp_loop_id=c.point.nodeValue,c.children.push(g.firstChild),c.point.parentNode.insertBefore(g.firstChild,c.point),e++;b.initListener()}})};miniVue.prototype.initListener=function(){this.listener_mouse();this.listener_model()};miniVue.prototype.checkListener=function(a,b){if(a.temp_listeners&&0<=a.temp_listeners.indexOf(b))return!0;a.temp_listeners||(a.temp_listeners=[]);a.temp_listeners.push(b);return!1};miniVue.prototype.analysisArgs=function(a){return 0>a.indexOf("(")?[]:a.slice(a.indexOf("(")+1,a.lastIndexOf(")")).split(",")};miniVue.prototype.listener_mouse=function(){var a=this,b="focus blur change scroll load unload click dbclick mouseover mouseout mousemove mousedown mouseup keypress keydown keyup touchstart touchmove touchend".split(" "),c=[];b.forEach(function(a,b){c[b]="*[\\@"+a+"]"});this.$mv=this.$data;Object.assign(this.$mv,this.$methods);c.forEach(function(c,e){a.getAttrDoms(c,"@"+b[e],function(c,d){a.checkListener(c,b[e])||c.addEventListener(b[e],function(){var b=d.split("(")[0],c=a.analysisArgs(d);c.forEach(function(b,d){c[d]=a.analysisExpression(b)});a.$methods[b].apply(a.$mv,c)})})})};miniVue.prototype.listener_model=function(){var a=this;this.getAttrDoms("input, textarea","v-model",function(b,c){a.checkListener(b,"input")||b.addEventListener("input",function(){a.setDataByKey(c,b.value)})});this.getAttrDoms("select","v-model",function(b,c){a.checkListener(b,"change")||b.addEventListener("change",function(){a.setDataByKey(c,b.options[b.options.selectedIndex].value)})})};